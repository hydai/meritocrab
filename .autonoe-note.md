# Session Notes — CLI-003 Implementation Complete

## Session Date
2026-02-13

## Task Completed
CLI-003: Add git-branch state backend with retry-on-conflict (shell git, no C deps)

## Accomplishments

Successfully implemented git-branch state backend for meritocrab-cli with all 11 acceptance criteria met:

1. **state init command**: Creates meritocrab-data orphan branch with credit-data/contributors.json and events.json
2. **Orphan branch isolation**: Branch has no files from main branch (true orphan)
3. **Non-destructive reads**: git show reads data without switching working tree branch
4. **Atomic updates**: New commits appear on meritocrab-data with updated state
5. **Audit trail**: Commit messages include PR number and event type (e.g., "meritocrab: update credit for alice (pr_merged #42)")
6. **Retry logic**: Retries up to 3 times with exponential backoff (1s, 2s, 4s) on concurrent conflicts
7. **Clear error messages**: Fails gracefully after 3 retries with user-friendly error
8. **Idempotent init**: Detects existing branch and preserves data
9. **Working tree isolation**: All git operations use tempfile::TempDir
10. **Remote support**: Push to origin works correctly
11. **No C dependencies**: Zero git2, libgit2-sys, or openssl-sys dependencies

## Implementation Details

### New Files
- **crates/meritocrab-cli/src/git_state.rs**: Git operations module (265 lines)
  - `init_git_state()`: Creates orphan branch with empty JSON files
  - `read_contributors()`: Reads from branch via `git show`
  - `update_git_state()`: Atomic update with clone/modify/commit/push in tempdir
  - `run_git()`: Helper for executing git commands via std::process::Command

### Modified Files
- **crates/meritocrab-cli/src/main.rs**:
  - Added StateBackend enum (File, Git)
  - Added State subcommand with init
  - Added --state-backend and --repo flags to credit check/update
  - Implemented retry logic with exponential backoff
  - Split credit_update into file/git backend handlers
- **crates/meritocrab-cli/Cargo.toml**:
  - Added tempfile = "3.17" dependency

### Key Design Decisions

1. **Shell git over libgit2**: Uses `std::process::Command` to avoid C library cross-compilation issues
2. **Tempdir isolation**: All git operations clone into temporary directories to avoid disrupting user's working tree
3. **Exponential backoff**: 1s → 2s → 4s retry delays for concurrent conflicts
4. **Atomic writes**: Clone → modify → commit → push pattern ensures consistency
5. **Backward compatibility**: File backend remains default, git is opt-in via --state-backend flag

### Retry Logic Flow

```
Attempt 1: Clone → Modify → Commit → Push
  ↓ (conflict detected)
Wait 1s
Attempt 2: Clone (fresh) → Modify → Commit → Push
  ↓ (conflict detected)
Wait 2s
Attempt 3: Clone (fresh) → Modify → Commit → Push
  ↓ (conflict detected)
Wait 4s
Error: "Failed to update git state after 3 retries..."
```

### Git Operations Architecture

**Reading state:**
```bash
git -C <repo> show meritocrab-data:credit-data/contributors.json
```

**Writing state:**
```bash
# In tempdir:
git clone --single-branch -b meritocrab-data <repo> /tmp/meritocrab-XXXX
# Modify files
git -C /tmp/meritocrab-XXXX add credit-data/
git -C /tmp/meritocrab-XXXX commit -m "meritocrab: update credit for alice (pr_merged #42)"
git -C /tmp/meritocrab-XXXX push origin meritocrab-data
```

**Initializing:**
```bash
# In tempdir:
git init
git checkout --orphan meritocrab-data
# Create empty JSON files
git add credit-data/
git commit -m "meritocrab: initialize state branch"
git remote add origin <repo>
git push origin meritocrab-data
```

## Testing Summary

### Manual Testing
- Created test repositories with and without remotes
- Verified all 11 acceptance criteria end-to-end
- Tested concurrent updates with 5 parallel processes
- Confirmed retry logic triggers and succeeds
- Verified idempotent init behavior
- Confirmed working tree isolation

### Unit Tests
- All 16 existing tests still pass
- No new unit tests added (git operations are integration tests)

### Verification Evidence
1. ✓ State init creates orphan branch with JSON files
2. ✓ Branch has no files from master (only credit-data/)
3. ✓ Reading via git backend doesn't switch branches
4. ✓ Updates create new commits on meritocrab-data
5. ✓ Commit messages include PR number and event type
6. ✓ Retry logic works: "Conflict detected on attempt 1/3, retrying after 1000ms..."
7. ✓ Max retries error: "Failed to update git state after 3 retries..."
8. ✓ Init on existing branch: "State already initialized: meritocrab-data branch exists"
9. ✓ Working tree remains clean after operations
10. ✓ Remote bare repository received pushed commits
11. ✓ `cargo tree | grep -i git2` returns nothing

## Issues Found and Fixed

None. Implementation proceeded smoothly with no regressions.

## Project Status

- All tests passing: 192 unit/integration tests + 5 doctests across entire workspace
- No clippy warnings (passed with -D warnings)
- No formatting issues (cargo fmt --all)
- Binary builds successfully with `--release`
- No C library dependencies (verified via cargo tree)
- CLI ready for GitHub Actions workflow integration

## Dependency Analysis

```
$ cargo tree -p meritocrab-cli --edges=normal | grep -i "git2\|libgit2\|openssl"
(no output - clean!)
```

Uses rustls-tls for HTTPS (pure Rust), macOS system frameworks for platform TLS (core-foundation-sys, security-framework-sys), but zero git2 or openssl dependencies.

## Next Steps

Task CLI-003 is complete and ready for the next task. The git-branch state backend is production-ready for GitHub Actions workflows. The next tasks are:

- **WF-001**: Create pr-evaluate.yml workflow template (uses CLI evaluate command)
- **WF-002**: Create pr-gate.yml workflow template (uses CLI credit check/update with --state-backend git)
- **WF-003**: Create pr-commands.yml workflow for /credit issue comment commands
- **DOC-001**: Create GitHub Actions mode setup guide (blocked by WF-002, WF-003)

The CLI now has all capabilities needed for stateless GitHub Actions execution:
- LLM evaluation (CLI-001)
- File-based state management (CLI-002)
- Git-branch state management (CLI-003) ← just completed
